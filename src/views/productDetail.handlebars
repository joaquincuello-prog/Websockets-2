<div style="margin-bottom: 20px;">
  <a href="/products" class="btn btn-primary">‚¨ÖÔ∏è Volver a Productos</a>
</div>

<div style="max-width: 1000px; margin: 0 auto;">
  <h1>{{product.title}}</h1>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px;">
    
    <!-- Columna izquierda: Imagen -->
    <div>
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 400px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
        {{#if product.thumbnails.length}}
          üì∑ {{product.thumbnails.length}} imagen(es)
        {{else}}
          üì¶ Sin imagen
        {{/if}}
      </div>
      
      {{#if product.thumbnails.length}}
        <div style="margin-top: 15px;">
          <strong>Im√°genes:</strong>
          <ul style="list-style: none; padding: 0; margin-top: 10px;">
            {{#each product.thumbnails}}
              <li style="background: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 5px; font-size: 14px;">
                üñºÔ∏è {{this}}
              </li>
            {{/each}}
          </ul>
        </div>
      {{/if}}
    </div>

    <!-- Columna derecha: Informaci√≥n -->
    <div>
      <div class="product-price" style="margin-bottom: 20px;">${{product.price}}</div>

      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h2 style="margin-bottom: 15px; font-size: 18px;">üìù Descripci√≥n</h2>
        <p style="color: #666; line-height: 1.6;">{{product.description}}</p>
      </div>

      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h2 style="margin-bottom: 15px; font-size: 18px;">‚ÑπÔ∏è Informaci√≥n del Producto</h2>
        
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
            <strong>C√≥digo:</strong>
            <span class="product-code">{{product.code}}</span>
          </div>

          <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
            <strong>Categor√≠a:</strong>
            <span>{{product.category}}</span>
          </div>

          <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
            <strong>Stock disponible:</strong>
            <span style="{{#if (eq product.stock 0)}}color: #dc3545; font-weight: bold;{{/if}}">
              {{product.stock}} unidades
            </span>
          </div>

          <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px;">
            <strong>Estado:</strong>
            <span class="product-status {{#if product.status}}status-active{{else}}status-inactive{{/if}}">
              {{#if product.status}}‚úì Activo{{else}}‚úó Inactivo{{/if}}
            </span>
          </div>
        </div>
      </div>

      <!-- Bot√≥n de agregar al carrito -->
      {{#if product.status}}
        {{#if (gt product.stock 0)}}
          <button class="btn btn-success btn-block" onclick="openAddToCartModal('{{product._id}}', '{{product.title}}', {{product.price}}, {{product.stock}})" style="font-size: 18px; padding: 15px;">
            üõí Agregar al Carrito
          </button>
        {{else}}
          <button class="btn btn-block" style="background: #dc3545; color: white; cursor: not-allowed; font-size: 18px; padding: 15px;" disabled>
            ‚ùå Sin Stock
          </button>
        {{/if}}
      {{else}}
        <button class="btn btn-block" style="background: #6c757d; color: white; cursor: not-allowed; font-size: 18px; padding: 15px;" disabled>
          ‚ö†Ô∏è Producto No Disponible
        </button>
      {{/if}}

      <a href="/products" class="btn btn-primary btn-block" style="margin-top: 15px;">
        ‚¨ÖÔ∏è Seguir Comprando
      </a>
    </div>
  </div>
</div>

<!-- Modal para agregar al carrito -->
<div id="addToCartModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üõí Agregar al Carrito</h2>
    </div>
    <div class="modal-body">
      <div class="modal-product-info">
        <div class="modal-product-title" id="modalProductTitle"></div>
        <div class="modal-product-price" id="modalProductPrice"></div>
      </div>

      <div class="quantity-selector">
        <label>Cantidad:</label>
        <div class="quantity-controls">
          <button type="button" class="quantity-btn" onclick="decreaseQuantity()">-</button>
          <input type="number" id="quantityInput" class="quantity-input" value="1" min="1" readonly>
          <button type="button" class="quantity-btn" onclick="increaseQuantity()">+</button>
        </div>
      </div>

      <div class="modal-total">
        <div class="modal-total-label">Total a agregar:</div>
        <div class="modal-total-value" id="modalTotal">$0</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeAddToCartModal()">Cancelar</button>
      <button class="btn btn-success" onclick="confirmAddToCart()">‚úì Confirmar</button>
    </div>
  </div>
</div>

<script>
  let currentProduct = null;
  let maxStock = 0;
  let unitPrice = 0;

  function openAddToCartModal(productId, title, price, stock) {
    currentProduct = productId;
    maxStock = stock;
    unitPrice = price;

    document.getElementById('modalProductTitle').textContent = title;
    document.getElementById('modalProductPrice').textContent = `$${price}`;
    document.getElementById('quantityInput').value = 1;
    document.getElementById('quantityInput').max = stock;
    updateModalTotal();

    document.getElementById('addToCartModal').classList.add('active');
  }

  function closeAddToCartModal() {
    document.getElementById('addToCartModal').classList.remove('active');
    currentProduct = null;
  }

  function increaseQuantity() {
    const input = document.getElementById('quantityInput');
    const current = parseInt(input.value);
    if (current < maxStock) {
      input.value = current + 1;
      updateModalTotal();
    } else {
      alert(`‚ö†Ô∏è Stock m√°ximo disponible: ${maxStock}`);
    }
  }

  function decreaseQuantity() {
    const input = document.getElementById('quantityInput');
    const current = parseInt(input.value);
    if (current > 1) {
      input.value = current - 1;
      updateModalTotal();
    }
  }

  function updateModalTotal() {
    const quantity = parseInt(document.getElementById('quantityInput').value);
    const total = unitPrice * quantity;
    document.getElementById('modalTotal').textContent = `$${total.toFixed(2)}`;
  }

  async function confirmAddToCart() {
    const quantity = parseInt(document.getElementById('quantityInput').value);
    
    try {
      let cartId = localStorage.getItem('cartId');
      
      if (!cartId) {
        const createResponse = await fetch('/api/carts', {
          method: 'POST'
        });
        const createData = await createResponse.json();
        cartId = createData.payload._id;
        localStorage.setItem('cartId', cartId);
      }

      for (let i = 0; i < quantity; i++) {
        await fetch(`/api/carts/${cartId}/product/${currentProduct}`, {
          method: 'POST'
        });
      }

      closeAddToCartModal();
      alert(`‚úÖ ${quantity} producto(s) agregado(s) al carrito`);
      
      if (confirm('¬øDeseas ver tu carrito?')) {
        window.location.href = `/carts/${cartId}`;
      }
    } catch (error) {
      alert('‚ùå Error al agregar producto: ' + error.message);
    }
  }

  document.getElementById('addToCartModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeAddToCartModal();
    }
  });
</script>

<style>
  @media (max-width: 768px) {
    div[style*="grid-template-columns: 1fr 1fr"] {
      display: block !important;
    }
  }
</style>