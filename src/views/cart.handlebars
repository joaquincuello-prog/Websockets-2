<h1>üõí Mi Carrito</h1>

<div style="max-width: 1200px; margin: 0 auto;">
  
  {{#if products.length}}
    
    <!-- Lista de productos en el carrito -->
    <div style="margin-bottom: 30px;">
      {{#each products}}
        <div class="cart-item">
          <!-- Imagen del producto -->
          <div class="cart-item-image">
            üì¶
          </div>

          <!-- Informaci√≥n del producto -->
          <div class="cart-item-info">
            <div class="cart-item-title">{{this.product.title}}</div>
            <div class="cart-item-description">{{this.product.description}}</div>
            
            <div class="cart-item-details">
              <div class="cart-detail-item">
                <span class="cart-detail-label">C√≥digo:</span>
                <span class="cart-detail-value">{{this.product.code}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Categor√≠a:</span>
                <span class="cart-detail-value">{{this.product.category}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Precio Unitario:</span>
                <span class="cart-detail-value">${{this.product.price}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Cantidad:</span>
                <span class="cart-detail-value">{{this.quantity}} unidades</span>
              </div>
              <div class="cart-detail-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <span class="cart-detail-label" style="color: white;">Subtotal:</span>
                <span class="cart-detail-value" style="font-size: 18px; font-weight: bold; color: white;">
                  ${{this.subtotal}}
                </span>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="cart-item-actions">
            <button class="btn btn-primary" onclick="openEditModal('{{../cartId}}', '{{this.product._id}}', '{{this.product.title}}', '{{this.product.price}}', '{{this.quantity}}', '{{this.product.stock}}')" style="padding: 10px; font-size: 14px;">
              ‚úèÔ∏è Editar Cantidad
            </button>
            <button class="btn btn-danger" onclick="removeFromCart('{{../cartId}}', '{{this.product._id}}')" style="padding: 10px; font-size: 14px;">
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>
      {{/each}}
    </div>

    <!-- Resumen del carrito -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Productos Diferentes</div>
          <div style="font-size: 32px; font-weight: bold;">{{productCount}}</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total de Items</div>
          <div style="font-size: 32px; font-weight: bold;">{{totalQuantity}}</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total a Pagar</div>
          <div style="font-size: 36px; font-weight: bold;">${{total}}</div>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <button class="btn btn-primary btn-block" onclick="window.location.href='/products'" style="font-size: 16px; padding: 15px;">
        ‚¨ÖÔ∏è Seguir Comprando
      </button>
      <button class="btn btn-danger btn-block" onclick="clearCart('{{cartId}}')" style="font-size: 16px; padding: 15px;">
        üóëÔ∏è Vaciar Carrito
      </button>
      <button class="btn btn-success btn-block" onclick="checkout('{{total}}')" style="font-size: 16px; padding: 15px;">
        üí≥ Proceder al Pago
      </button>
    </div>

  {{else}}
    <div class="empty-message">
      <div style="font-size: 72px; margin-bottom: 20px;">üõí</div>
      <div style="font-size: 24px; margin-bottom: 20px;">Tu carrito est√° vac√≠o</div>
      <a href="/products" class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;">
        üõçÔ∏è Ir a Comprar
      </a>
    </div>
  {{/if}}

</div>

<!-- Modal para editar cantidad -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è Editar Cantidad</h2>
    </div>
    <div class="modal-body">
      <div class="modal-product-info">
        <div class="modal-product-title" id="modalTitle"></div>
        <div class="modal-product-price">
          <span style="font-size: 14px; color: #666;">Precio Unitario:</span>
          <span id="modalPrice" style="font-size: 24px; color: #667eea; font-weight: bold;"></span>
        </div>
      </div>

      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
        <strong>üì¶ Cantidad actual:</strong> <span id="modalCurrentQty" style="font-size: 18px; font-weight: bold;"></span> unidades
      </div>

      <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
        <strong>üìä Stock disponible:</strong> <span id="modalStock" style="font-size: 18px; font-weight: bold;"></span> unidades
      </div>

      <div class="quantity-selector">
        <label>Nueva Cantidad:</label>
        <div class="quantity-controls">
          <button type="button" class="quantity-btn" onclick="decreaseQty()">-</button>
          <input type="number" id="qtyInput" class="quantity-input" value="1" min="1">
          <button type="button" class="quantity-btn" onclick="increaseQty()">+</button>
        </div>
      </div>

      <div class="modal-total">
        <div class="modal-total-label">Nuevo Subtotal:</div>
        <div class="modal-total-value" id="modalSubtotal">$0.00</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeEditModal()">Cancelar</button>
      <button class="btn btn-success" onclick="saveQuantity()">‚úì Guardar Cambios</button>
    </div>
  </div>
</div>

<script>
  let currentCartId = null;
  let currentProductId = null;
  let currentStock = 0;
  let currentPrice = 0;

  function openEditModal(cartId, productId, title, price, quantity, stock) {
    currentCartId = cartId;
    currentProductId = productId;
    currentStock = parseInt(stock);
    currentPrice = parseFloat(price);

    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalPrice').textContent = '$' + price;
    document.getElementById('modalCurrentQty').textContent = quantity;
    document.getElementById('modalStock').textContent = stock;
    document.getElementById('qtyInput').value = quantity;
    document.getElementById('qtyInput').max = stock;
    
    updateSubtotal();
    document.getElementById('editModal').classList.add('active');
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
  }

  function increaseQty() {
    const input = document.getElementById('qtyInput');
    const val = parseInt(input.value);
    if (val < currentStock) {
      input.value = val + 1;
      updateSubtotal();
    } else {
      alert('‚ö†Ô∏è Stock m√°ximo: ' + currentStock);
    }
  }

  function decreaseQty() {
    const input = document.getElementById('qtyInput');
    const val = parseInt(input.value);
    if (val > 1) {
      input.value = val - 1;
      updateSubtotal();
    }
  }

  function updateSubtotal() {
    const qty = parseInt(document.getElementById('qtyInput').value);
    const subtotal = currentPrice * qty;
    document.getElementById('modalSubtotal').textContent = '$' + subtotal.toFixed(2);
  }

  document.getElementById('qtyInput').addEventListener('input', function() {
    const val = parseInt(this.value) || 1;
    if (val < 1) this.value = 1;
    if (val > currentStock) {
      this.value = currentStock;
      alert('‚ö†Ô∏è Stock m√°ximo: ' + currentStock);
    }
    updateSubtotal();
  });

  async function saveQuantity() {
    const newQty = parseInt(document.getElementById('qtyInput').value);
    
    try {
      const response = await fetch('/api/carts/' + currentCartId + '/products/' + currentProductId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: newQty })
      });

      const data = await response.json();
      if (data.status === 'success') {
        alert('‚úÖ Cantidad actualizada');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  async function removeFromCart(cartId, productId) {
    if (!confirm('¬øEliminar este producto del carrito?')) return;

    try {
      const response = await fetch('/api/carts/' + cartId + '/products/' + productId, {
        method: 'DELETE'
      });

      const data = await response.json();
      if (data.status === 'success') {
        alert('‚úÖ Producto eliminado');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  async function clearCart(cartId) {
    if (!confirm('¬øVaciar todo el carrito?')) return;

    try {
      const response = await fetch('/api/carts/' + cartId, {
        method: 'DELETE'
      });

      const data = await response.json();
      if (data.status === 'success') {
        alert('‚úÖ Carrito vaciado');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  function checkout(total) {
    alert('üöß Funcionalidad de pago en desarrollo\n\nüí∞ Total: $' + total);
  }

  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
  });
</script>
