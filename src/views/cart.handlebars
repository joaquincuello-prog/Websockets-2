<h1>üõí Mi Carrito</h1>

<div style="max-width: 1200px; margin: 0 auto;">
  
  {{#if products.length}}
    
    <!-- Lista de productos en el carrito -->
    <div style="margin-bottom: 30px;">
      {{#each products}}
        <div class="cart-item">
          <!-- Imagen del producto -->
          {{!-- Vacia la informacion-imagen --}}
          <div class="cart-item-image">
            üì¶
          </div>

          <!-- Informaci√≥n del producto -->
          <div class="cart-item-info">
            <div class="cart-item-title">{{this.product.title}}</div>
            <div class="cart-item-description">{{this.product.description}}</div>
            
            <div class="cart-item-details">
              <div class="cart-detail-item">
                <span class="cart-detail-label">C√≥digo:</span>
                <span class="cart-detail-value">{{this.product.code}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Categor√≠a:</span>
                <span class="cart-detail-value">{{this.product.category}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Precio Unitario:</span>
                <span class="cart-detail-value">${{this.product.price}}</span>
              </div>
              <div class="cart-detail-item">
                <span class="cart-detail-label">Cantidad:</span>
                <span class="cart-detail-value">{{this.quantity}} unidades</span>
              </div>
              <div class="cart-detail-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <span class="cart-detail-label" style="color: white;">Subtotal:</span>
                <span class="cart-detail-value" style="font-size: 18px; font-weight: bold; color: white;">
                  $<span class="subtotal-value" data-price="{{this.product.price}}" data-quantity="{{this.quantity}}"></span>
                </span>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="cart-item-actions">
            <button class="btn btn-primary" onclick="openEditQuantityModal('{{../cartId}}', '{{this.product._id}}', '{{this.product.title}}', {{this.product.price}}, {{this.quantity}}, {{this.product.stock}})" style="padding: 10px; font-size: 14px;">
              ‚úèÔ∏è Editar Cantidad
            </button>
            <button class="btn btn-danger" onclick="removeFromCart('{{../cartId}}', '{{this.product._id}}')" style="padding: 10px; font-size: 14px;">
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>
      {{/each}}
    </div>

    <!-- Resumen del carrito -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total de Productos</div>
          <div style="font-size: 32px; font-weight: bold;">{{products.length}}</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Cantidad Total de Items</div>
          <div style="font-size: 32px; font-weight: bold;" id="totalQuantity">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total a Pagar</div>
          <div style="font-size: 36px; font-weight: bold;" id="grandTotal">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <button class="btn btn-primary btn-block" onclick="window.location.href='/products'" style="font-size: 16px; padding: 15px;">
        ‚¨ÖÔ∏è Seguir Comprando
      </button>
      <button class="btn btn-danger btn-block" onclick="clearCart('{{cartId}}')" style="font-size: 16px; padding: 15px;">
        üóëÔ∏è Vaciar Carrito
      </button>
      <button class="btn btn-success btn-block" onclick="checkout()" style="font-size: 16px; padding: 15px;">
        üí≥ Proceder al Pago
      </button>
    </div>

  {{else}}
    <div class="empty-message">
      <div style="font-size: 72px; margin-bottom: 20px;">üõí</div>
      <div style="font-size: 24px; margin-bottom: 20px;">Tu carrito est√° vac√≠o</div>
      <a href="/products" class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;">
        üõçÔ∏è Ir a Comprar
      </a>
    </div>
  {{/if}}

</div>

<!-- Modal para editar cantidad -->
<div id="editQuantityModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è Editar Cantidad</h2>
    </div>
    <div class="modal-body">
      <div class="modal-product-info">
        <div class="modal-product-title" id="editModalProductTitle"></div>
        <div class="modal-product-price">
          <span style="font-size: 14px; color: #666;">Precio Unitario:</span>
          <span id="editModalProductPrice" style="font-size: 24px; color: #667eea; font-weight: bold;"></span>
        </div>
      </div>

      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
        <strong>üì¶ Cantidad actual en el carrito:</strong> <span id="editModalCurrentQuantity" style="font-size: 18px; font-weight: bold;"></span> unidades
      </div>

      <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
        <strong>üìä Stock disponible:</strong> <span id="editModalStock" style="font-size: 18px; font-weight: bold;"></span> unidades
      </div>

      <div class="quantity-selector">
        <label>Nueva Cantidad:</label>
        <div class="quantity-controls">
          <button type="button" class="quantity-btn" onclick="decreaseEditQuantity()">-</button>
          <input type="number" id="editQuantityInput" class="quantity-input" value="1" min="1">
          <button type="button" class="quantity-btn" onclick="increaseEditQuantity()">+</button>
        </div>
      </div>

      <div class="modal-total">
        <div class="modal-total-label">Nuevo Subtotal:</div>
        <div class="modal-total-value" id="editModalTotal">$0.00</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeEditQuantityModal()">Cancelar</button>
      <button class="btn btn-success" onclick="confirmEditQuantity()">‚úì Guardar Cambios</button>
    </div>
  </div>
</div>

<script>
  let editCartId = null;
  let editProductId = null;
  let editMaxStock = 0;
  let editUnitPrice = 0;

  //  Calcular subtotales y totales al cargar
  document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
  });

  function calculateTotals() {
    // Calcular cada subtotal
    const subtotalElements = document.querySelectorAll('.subtotal-value');
    let grandTotal = 0;
    let totalQuantity = 0;

    subtotalElements.forEach(el => {
      const price = parseFloat(el.dataset.price);
      const quantity = parseInt(el.dataset.quantity);
      const subtotal = price * quantity;
      
      el.textContent = subtotal.toFixed(2);
      grandTotal += subtotal;
      totalQuantity += quantity;
    });

    // Actualizar el total general
    const grandTotalElement = document.getElementById('grandTotal');
    if (grandTotalElement) {
      grandTotalElement.textContent = `$${grandTotal.toFixed(2)}`;
    }

    // Actualizar cantidad total
    const totalQuantityElement = document.getElementById('totalQuantity');
    if (totalQuantityElement) {
      totalQuantityElement.textContent = totalQuantity;
    }
  }

  //  Abrir modal de edici√≥n
  function openEditQuantityModal(cartId, productId, title, price, currentQuantity, stock) {
    editCartId = cartId;
    editProductId = productId;
    editMaxStock = stock;
    editUnitPrice = price;

    document.getElementById('editModalProductTitle').textContent = title;
    document.getElementById('editModalProductPrice').textContent = `$${price.toFixed(2)}`;
    document.getElementById('editModalCurrentQuantity').textContent = currentQuantity;
    document.getElementById('editModalStock').textContent = stock;
    document.getElementById('editQuantityInput').value = currentQuantity;
    document.getElementById('editQuantityInput').max = stock;
    updateEditModalTotal();

    document.getElementById('editQuantityModal').classList.add('active');
  }

  function closeEditQuantityModal() {
    document.getElementById('editQuantityModal').classList.remove('active');
    editCartId = null;
    editProductId = null;
  }

  function increaseEditQuantity() {
    const input = document.getElementById('editQuantityInput');
    const current = parseInt(input.value);
    if (current < editMaxStock) {
      input.value = current + 1;
      updateEditModalTotal();
    } else {
      alert(`‚ö†Ô∏è Stock m√°ximo disponible: ${editMaxStock} unidades`);
    }
  }

  function decreaseEditQuantity() {
    const input = document.getElementById('editQuantityInput');
    const current = parseInt(input.value);
    if (current > 1) {
      input.value = current - 1;
      updateEditModalTotal();
    }
  }

  // Permitir escribir la cantidad manualmente
  document.addEventListener('DOMContentLoaded', function() {
    const editInput = document.getElementById('editQuantityInput');
    if (editInput) {
      editInput.addEventListener('input', function() {
        const value = parseInt(this.value) || 1;
        if (value < 1) {
          this.value = 1;
        } else if (value > editMaxStock) {
          this.value = editMaxStock;
          alert(`‚ö†Ô∏è Stock m√°ximo disponible: ${editMaxStock} unidades`);
        }
        updateEditModalTotal();
      });
    }
  });

  function updateEditModalTotal() {
    const quantity = parseInt(document.getElementById('editQuantityInput').value) || 1;
    const total = editUnitPrice * quantity;
    document.getElementById('editModalTotal').textContent = `$${total.toFixed(2)}`;
  }

  //  Confirmar edici√≥n de cantidad
  async function confirmEditQuantity() {
    const newQuantity = parseInt(document.getElementById('editQuantityInput').value);
    
    if (newQuantity < 1) {
      alert('‚ùå La cantidad debe ser al menos 1');
      return;
    }

    if (newQuantity > editMaxStock) {
      alert(`‚ùå Stock m√°ximo disponible: ${editMaxStock} unidades`);
      return;
    }

    try {
      const response = await fetch(`/api/carts/${editCartId}/products/${editProductId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ quantity: newQuantity })
      });

      const data = await response.json();

      if (data.status === 'success') {
        closeEditQuantityModal();
        alert('‚úÖ Cantidad actualizada correctamente');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error al actualizar cantidad: ' + error.message);
    }
  }

  //  Eliminar producto del carrito
  async function removeFromCart(cartId, productId) {
    if (!confirm('¬øEst√°s seguro de eliminar este producto del carrito?')) {
      return;
    }

    try {
      const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.status === 'success') {
        alert('‚úÖ Producto eliminado del carrito');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error al eliminar producto: ' + error.message);
    }
  }

  //  Vaciar el carrito completo
  async function clearCart(cartId) {
    if (!confirm('¬øEst√°s seguro de vaciar todo el carrito? Esta acci√≥n no se puede deshacer.')) {
      return;
    }

    try {
      const response = await fetch(`/api/carts/${cartId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.status === 'success') {
        alert('‚úÖ Carrito vaciado correctamente');
        location.reload();
      } else {
        alert('‚ùå Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error al vaciar carrito: ' + error.message);
    }
  }

  //  Proceder al pago
  // no funcinal a√∫n
  function checkout() {
    const total = document.getElementById('grandTotal').textContent;
    alert(`üöß Funcionalidad de pago en desarrollo\n\nüí∞ Total a pagar: ${total}\n\nPronto podr√°s completar tu compra.`);
  }

  // Cerrar modal al hacer clic fuera
  document.getElementById('editQuantityModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditQuantityModal();
    }
  });
</script>

<style>
  .cart-detail-item {
    padding: 10px 15px;
  }

  .cart-detail-value {
    font-weight: bold;
  }

  .quantity-input {
    -moz-appearance: textfield;
  }

  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  @media (max-width: 768px) {
    .cart-item {
      grid-template-columns: 1fr !important;
    }

    .cart-item-image {
      margin: 0 auto;
    }

    .cart-item-details {
      flex-direction: column;
    }

    .cart-detail-item {
      width: 100%;
    }
  }
</style>