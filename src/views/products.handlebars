<h1>üõçÔ∏è Cat√°logo de Productos</h1>

{{#if error}}
  <div class="error-message">
    ‚ö†Ô∏è {{error}}
  </div>
{{/if}}

<!-- Opcion de Filtros y b√∫squeda -->
<form class="filters" method="GET" action="/products">
  <div class="filter-group">
    <label for="query">Buscar por:</label>
    <select name="query" id="query">
      <option value="">Todos los productos</option>
      <option value="available" {{#if (eq currentQuery 'available')}}selected{{/if}}>Disponibles</option>
      <option value="unavailable" {{#if (eq currentQuery 'unavailable')}}selected{{/if}}>No disponibles</option>
      <option value="category:Electr√≥nica" {{#if (eq currentQuery 'category:Electr√≥nica')}}selected{{/if}}>Electr√≥nica</option>
      <option value="category:Ropa" {{#if (eq currentQuery 'category:Ropa')}}selected{{/if}}>Ropa</option>
      <option value="category:Hogar" {{#if (eq currentQuery 'category:Hogar')}}selected{{/if}}>Hogar</option>
      <option value="category:Deportes" {{#if (eq currentQuery 'category:Deportes')}}selected{{/if}}>Deportes</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="sort">Ordenar por precio:</label>
    <select name="sort" id="sort">
      <option value="">Sin ordenar</option>
      <option value="asc" {{#if (eq currentSort 'asc')}}selected{{/if}}>Menor a mayor</option>
      <option value="desc" {{#if (eq currentSort 'desc')}}selected{{/if}}>Mayor a menor</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="limit">Productos por p√°gina:</label>
    <select name="limit" id="limit">
      <option value="5" {{#if (eq currentLimit '5')}}selected{{/if}}>5</option>
      <option value="10" {{#if (eq currentLimit '10')}}selected{{/if}}>10</option>
      <option value="20" {{#if (eq currentLimit '20')}}selected{{/if}}>20</option>
      <option value="50" {{#if (eq currentLimit '50')}}selected{{/if}}>50</option>
    </select>
  </div>

  <button type="submit" class="btn-filter">üîç Aplicar Filtros</button>
</form>

<!-- Grid de productos -->
{{#if products.length}}
  <div class="product-grid">
    {{#each products}}
      <div class="product-card">
        <div class="product-title">{{this.title}}</div>
        <div class="product-description">{{this.description}}</div>
        <div class="product-price">${{this.price}}</div>
        
        <div class="product-info">
          <span class="product-code">{{this.code}}</span>
          <span>Stock: {{this.stock}}</span>
        </div>
        
        <div class="product-info">
          <span>{{this.category}}</span>
          <span class="product-status {{#if this.status}}status-active{{else}}status-inactive{{/if}}">
            {{#if this.status}}‚úì Activo{{else}}‚úó Inactivo{{/if}}
          </span>
        </div>

        <!-- Botones de acci√≥n -->
        <a href="/products/{{this._id}}" class="btn btn-primary btn-block">
          üëÅÔ∏è Ver Detalles
        </a>
        
        {{#if this.status}}
          {{#if (gt this.stock 0)}}
            <button class="btn btn-success btn-block" onclick="openAddToCartModal('{{this._id}}', '{{this.title}}', {{this.price}}, {{this.stock}})">
              üõí Agregar al Carrito
            </button>
          {{else}}
            <button class="btn btn-block" style="background: #6c757d; color: white; cursor: not-allowed;" disabled>
              Sin Stock
            </button>
          {{/if}}
        {{/if}}
      </div>
    {{/each}}
  </div>

  <!-- Paginas -->
  <div class="pagination">
    {{#if hasPrevPage}}
      <a href="{{prevLink}}">‚¨ÖÔ∏è Anterior</a>
    {{else}}
      <span class="disabled">‚¨ÖÔ∏è Anterior</span>
    {{/if}}

    <span class="active">P√°gina {{page}} de {{totalPages}}</span>

    {{#if hasNextPage}}
      <a href="{{nextLink}}">Siguiente ‚û°Ô∏è</a>
    {{else}}
      <span class="disabled">Siguiente ‚û°Ô∏è</span>
    {{/if}}
  </div>

  <div style="text-align: center; margin-top: 15px; color: #666;">
    Mostrando {{products.length}} productos
  </div>

{{else}}
  <div class="empty-message">
    üì≠ No hay productos disponibles con los filtros seleccionados
  </div>
{{/if}}

<!-- Modal para agregar al carrito -->
<div id="addToCartModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üõí Agregar al Carrito</h2>
    </div>
    <div class="modal-body">
      <div class="modal-product-info">
        <div class="modal-product-title" id="modalProductTitle"></div>
        <div class="modal-product-price" id="modalProductPrice"></div>
      </div>

      <div class="quantity-selector">
        <label>Cantidad:</label>
        <div class="quantity-controls">
          <button type="button" class="quantity-btn" onclick="decreaseQuantity()">-</button>
          <input type="number" id="quantityInput" class="quantity-input" value="1" min="1" readonly>
          <button type="button" class="quantity-btn" onclick="increaseQuantity()">+</button>
        </div>
      </div>

      <div class="modal-total">
        <div class="modal-total-label">Total a agregar:</div>
        <div class="modal-total-value" id="modalTotal">$0</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeAddToCartModal()">Cancelar</button>
      <button class="btn btn-success" onclick="confirmAddToCart()">‚úì Confirmar</button>
    </div>
  </div>
</div>

<script>
  let currentProduct = null;
  let maxStock = 0;
  let unitPrice = 0;

  function openAddToCartModal(productId, title, price, stock) {
    currentProduct = productId;
    maxStock = stock;
    unitPrice = price;

    document.getElementById('modalProductTitle').textContent = title;
    document.getElementById('modalProductPrice').textContent = `$${price}`;
    document.getElementById('quantityInput').value = 1;
    document.getElementById('quantityInput').max = stock;
    updateModalTotal();

    document.getElementById('addToCartModal').classList.add('active');
  }

  function closeAddToCartModal() {
    document.getElementById('addToCartModal').classList.remove('active');
    currentProduct = null;
  }

  function increaseQuantity() {
    const input = document.getElementById('quantityInput');
    const current = parseInt(input.value);
    if (current < maxStock) {
      input.value = current + 1;
      updateModalTotal();
    }
  }

  function decreaseQuantity() {
    const input = document.getElementById('quantityInput');
    const current = parseInt(input.value);
    if (current > 1) {
      input.value = current - 1;
      updateModalTotal();
    }
  }

  function updateModalTotal() {
    const quantity = parseInt(document.getElementById('quantityInput').value);
    const total = unitPrice * quantity;
    document.getElementById('modalTotal').textContent = `$${total.toFixed(2)}`;
  }

  async function confirmAddToCart() {
    const quantity = parseInt(document.getElementById('quantityInput').value);
    
    try {
      let cartId = localStorage.getItem('cartId');
      
      if (!cartId) {
        const createResponse = await fetch('/api/carts', {
          method: 'POST'
        });
        const createData = await createResponse.json();
        cartId = createData.payload._id;
        localStorage.setItem('cartId', cartId);
      }

      for (let i = 0; i < quantity; i++) {
        await fetch(`/api/carts/${cartId}/product/${currentProduct}`, {
          method: 'POST'
        });
      }

      closeAddToCartModal();
      updateCartBadge();
      alert(`‚úÖ ${quantity} producto(s) agregado(s) al carrito`);
      
      if (confirm('¬øDeseas ver tu carrito?')) {
        window.location.href = `/carts/${cartId}`;
      }
    } catch (error) {
      alert('‚ùå Error al agregar producto: ' + error.message);
    }
  }

  // Cerrar modal al hacer clic fuera
  document.getElementById('addToCartModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeAddToCartModal();
    }
  });
</script>