<h1>‚ö° Productos en Tiempo Real (WebSockets)</h1>

<div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
  <strong>üîå Estado de conexi√≥n:</strong> <span id="connectionStatus" style="font-weight: bold; color: #28a745;">Conectado</span>
</div>

<form id="productForm">
  <h2>‚ûï Agregar Nuevo Producto (por WebSocket)</h2>
  
  <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
    <div class="form-group">
      <label for="title">T√≠tulo *</label>
      <input type="text" id="title" name="title" required placeholder="Ej: iPhone 14">
    </div>
    
    <div class="form-group">
      <label for="code">C√≥digo *</label>
      <input type="text" id="code" name="code" required placeholder="Ej: PROD001">
    </div>
  </div>
  
  <div class="form-group">
    <label for="description">Descripci√≥n *</label>
    <textarea id="description" name="description" required placeholder="Describe el producto..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 80px;"></textarea>
  </div>
  
  <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
    <div class="form-group">
      <label for="price">Precio *</label>
      <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
    </div>
    
    <div class="form-group">
      <label for="stock">Stock *</label>
      <input type="number" id="stock" name="stock" required placeholder="0">
    </div>
  </div>
  
  <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
    <div class="form-group">
      <label for="category">Categor√≠a *</label>
      <input type="text" id="category" name="category" required placeholder="Ej: Electr√≥nica">
    </div>
    
    <div class="form-group">
      <label for="status">Estado</label>
      <select id="status" name="status" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <option value="true">Activo</option>
        <option value="false">Inactivo</option>
      </select>
    </div>
  </div>
  
  <button type="submit" class="btn btn-success btn-block" style="margin-top: 15px; font-size: 16px; padding: 12px;">
    ‚ûï Agregar Producto (WebSocket)
  </button>
</form>

<div style="text-align: center; margin: 20px 0;">
  <button class="btn btn-primary" onclick="requestProducts()" style="padding: 12px 24px;">
    üîÑ Actualizar Lista
  </button>
</div>

<div id="productList" class="product-grid" style="margin-top: 30px;">
  {{#if products.length}}
    {{#each products}}
      <div class="product-card" data-id="{{this._id}}">
        <div class="product-title">{{this.title}}</div>
        <div class="product-description">{{this.description}}</div>
        <div class="product-price">${{this.price}}</div>
        <div class="product-info">
          <span class="product-code">{{this.code}}</span>
          <span>Stock: {{this.stock}}</span>
        </div>
        <div class="product-info">
          <span>{{this.category}}</span>
          <span class="product-status {{#if this.status}}status-active{{else}}status-inactive{{/if}}">
            {{#if this.status}}‚úì Activo{{else}}‚úó Inactivo{{/if}}
          </span>
        </div>
        <button class="btn btn-danger btn-block" onclick="deleteProduct('{{this._id}}')">
          üóëÔ∏è Eliminar (WebSocket)
        </button>
      </div>
    {{/each}}
  {{else}}
    <div class="empty-message">
      üì≠ No hay productos disponibles
    </div>
  {{/if}}
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  //  CONEXI√ìN WEBSOCKET
  const socket = io();

  // Estado de conexi√≥n
  socket.on('connect', () => {
    console.log('‚úÖ Conectado al servidor WebSocket');
    document.getElementById('connectionStatus').textContent = 'Conectado';
    document.getElementById('connectionStatus').style.color = '#28a745';
  });

  socket.on('disconnect', () => {
    console.log('‚ùå Desconectado del servidor WebSocket');
    document.getElementById('connectionStatus').textContent = 'Desconectado';
    document.getElementById('connectionStatus').style.color = '#dc3545';
  });

  //  RECIBIR LISTA ACTUALIZADA DE PRODUCTOS
  socket.on('updateProducts', (products) => {
    console.log('üì° Lista de productos actualizada recibida:', products.length, 'productos');
    renderProducts(products);
  });

  //  CONFIRMAR CREACI√ìN DE PRODUCTO
  socket.on('productCreated', (response) => {
    if (response.success) {
      console.log('‚úÖ Producto creado:', response.product);
      alert('‚úÖ ' + response.message);
      document.getElementById('productForm').reset();
    } else {
      console.error('‚ùå Error:', response.message);
      alert('‚ùå Error: ' + response.message);
    }
  });

  //  CONFIRMAR ELIMINACI√ìN DE PRODUCTO
  socket.on('productDeleted', (response) => {
    if (response.success) {
      console.log('‚úÖ Producto eliminado:', response.product);
      alert('‚úÖ ' + response.message);
    } else {
      console.error('‚ùå Error:', response.message);
      alert('‚ùå Error: ' + response.message);
    }
  });

  //  MANEJO DE ERRORES
  socket.on('error', (error) => {
    console.error('‚ùå Error del servidor:', error);
    alert('‚ùå Error: ' + error.message);
  });

  //  CREAR PRODUCTO POR WEBSOCKET
  document.getElementById('productForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = {
      title: document.getElementById('title').value,
      description: document.getElementById('description').value,
      code: document.getElementById('code').value,
      price: parseFloat(document.getElementById('price').value),
      stock: parseInt(document.getElementById('stock').value),
      category: document.getElementById('category').value,
      status: document.getElementById('status').value === 'true'
    };

    console.log('üì§ Enviando solicitud de creaci√≥n por WebSocket:', formData);
    socket.emit('createProduct', formData);
  });

  //  ELIMINAR PRODUCTO POR WEBSOCKET
  function deleteProduct(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
      return;
    }

    console.log('üì§ Enviando solicitud de eliminaci√≥n por WebSocket:', id);
    socket.emit('deleteProduct', id);
  }

  //  SOLICITAR LISTA ACTUALIZADA
  function requestProducts() {
    console.log('üì§ Solicitando lista actualizada de productos');
    socket.emit('requestProducts');
  }

  //  RENDERIZAR PRODUCTOS EN EL DOM
  function renderProducts(products) {
    const productList = document.getElementById('productList');

    if (products.length === 0) {
      productList.innerHTML = '<div class="empty-message">üì≠ No hay productos disponibles</div>';
      return;
    }

    productList.innerHTML = products.map(product => `
      <div class="product-card" data-id="${product._id}">
        <div class="product-title">${product.title}</div>
        <div class="product-description">${product.description}</div>
        <div class="product-price">$${product.price}</div>
        <div class="product-info">
          <span class="product-code">${product.code}</span>
          <span>Stock: ${product.stock}</span>
        </div>
        <div class="product-info">
          <span>${product.category}</span>
          <span class="product-status ${product.status ? 'status-active' : 'status-inactive'}">
            ${product.status ? '‚úì Activo' : '‚úó Inactivo'}
          </span>
        </div>
        <button class="btn btn-danger btn-block" onclick="deleteProduct('${product._id}')">
          üóëÔ∏è Eliminar (WebSocket)
        </button>
      </div>
    `).join('');
  }

  console.log('üîå Sistema de WebSockets inicializado correctamente');
</script>

<style>
  .form-group {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
  }

  input[type="text"],
  input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
  }

  form {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    margin-bottom: 30px;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr !important;
    }
  }
</style>